<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å½±å­è·Ÿè¯» Pro V64 (å•è¯Fix)</title>
<style>
:root { --primary: #1A73E8; --green: #34A853; --orange: #FBBC04; --red: #EA4335; --purple: #A142F4; --bg: #F8F9FA; --text: #202124; --border: #DADCE0; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Google Sans', Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
.navbar { background: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; height: 50px; }
.nav-title { font-weight: 500; font-size: 18px; color: var(--primary); }
.mode-switch { background: #F1F3F4; padding: 3px; border-radius: 20px; }
.mode-btn { border: none; background: none; padding: 6px 16px; font-weight: 700; border-radius: 18px; color: #5F6368; cursor: pointer; transition: 0.2s; font-size: 14px; }
.mode-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.view-container { flex: 1; width: 100%; position: relative; overflow: hidden; }

/* ç¼–è¾‘é¡µ */
#editor-view { width: 100%; height: 100%; overflow-y: auto; padding: 16px; max-width: 800px; margin: 0 auto; display: block; }

/* ç»ƒä¹ é¡µ */
#practice-view { width: 100%; height: 100%; padding: 0; display: none; flex-direction: column; align-items: center; }
#practice-view.active { display: flex; }

.card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(60,64,67,0.15); border: 1px solid #eee; }
.practice-card { background: #fff; width: 100%; height: 100%; max-width: 800px; padding: 12px; display: flex; flex-direction: column; box-shadow: none; position: relative; }
@media (min-width: 800px) { .practice-card { height: 96%; margin-top: 2%; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 24px; } }

/* Header & Sleep Timer */
.practice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-shrink: 0; height: 40px; position: relative; z-index: 20; }
.icon-btn { font-size: 24px; cursor: pointer; padding: 5px; color: #5F6368; z-index: 2; user-select: none; }
.header-right-group { display: flex; align-items: center; gap: 10px; z-index: 2; }
.sleep-wrapper { position: relative; display: flex; align-items: center; }
.sleep-display { font-size: 13px; color: var(--orange); font-weight: bold; margin-left: 4px; display: none; font-family: monospace; }
.sleep-popup { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; display: none; width: 180px; z-index: 100; margin-top: 5px; }
.sleep-popup.show { display: block; }
.text-toggle { font-size: 14px; font-weight: 600; color: var(--primary); cursor: pointer; padding: 5px; }

.jump-select-wrapper { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1; width: 100%; text-align: center; pointer-events: none; }
.jump-select { font-size: 15px; font-weight: 600; background: #F1F3F4; border: none; padding: 6px 20px; border-radius: 20px; outline: none; text-align: center; pointer-events: auto; }

.sub-switcher { display: flex; gap: 6px; justify-content: center; margin-bottom: 5px; flex-shrink: 0; min-height: 28px; }
.sub-btn { font-size: 12px; padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border); background: #fff; cursor: pointer; color: #5F6368; transition: 0.2s; }
.sub-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

.practice-text-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; margin: 5px 0 10px 0; background: #FAFAFA; border-radius: 12px; border: 1px dashed #E0E0E0; overflow: hidden; min-height: 0; }
.practice-text { width: 100%; padding: 10px 15px; line-height: 1.4; font-weight: 500; color: var(--text); text-align: center; font-size: 34px; white-space: pre-wrap; overflow-y: auto; max-height: 100%; }
.practice-text.blur { filter: blur(10px); opacity: 0.3; overflow: hidden; }
.click-hint { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #999; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 10px; pointer-events: none; opacity: 0; transition: opacity 0.5s ease; }
.click-hint.show { opacity: 1; }

.control-area { flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; margin-top: auto; padding-top: 8px; border-top: 1px solid #f5f5f5; }
.row-mixed { display: grid; grid-template-columns: 2fr 3fr; gap: 8px; height: 44px; }
.btn-full-play { width: 100%; height: 100%; background: var(--purple); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 0 4px; white-space: nowrap; }
.btn-full-play.active { background: #7C28C7; animation: pulse 2s infinite; }
.range-panel { width: 100%; height: 100%; background: #FEF7E0; border: 1px solid #FFE0B2; border-radius: 10px; display: flex; align-items: center; justify-content: space-evenly; padding: 0 5px; }
.range-label { font-size: 12px; color: #E37400; font-weight: bold; margin-right: 2px; }
.range-input { width: 32px; text-align: center; border: 1px solid #FFCC80; border-radius: 4px; padding: 2px 0; font-weight: bold; background: #fff; font-size: 13px; box-sizing: border-box; }
.btn-range-play { background: var(--orange); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; white-space: nowrap; }
.btn-range-play.active { background: #E37400; animation: pulse 2s infinite; }

.row-dual { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 44px; }
.btn-action { border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
.btn-blue { background: #E8F0FE; color: var(--primary); } 
.btn-blue.active { background: var(--primary); color: white; }
.btn-orange { background: #FFF3E0; color: #E37400; border: 1px solid #FFE0B2; } 
.btn-orange.active { background: var(--orange); color: white; border-color: var(--orange); }

.btn-record { width: 100%; height: 54px; border-radius: 27px; border: 2px solid #EEE; background: #fff; font-size: 16px; font-weight: 700; color: #5F6368; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
.btn-record.recording { background: #FCE8E6; border-color: var(--red); color: var(--red); animation: pulse 1s infinite; }
.btn-record.playing { background: #E6F4EA; border-color: var(--green); color: var(--green); }
.btn-nav { background: #F1F3F4; color: #3C4043; }

/* ç¼–è¾‘é¡µåˆ—è¡¨ */
.sub-item { background: #fff; padding: 16px; border: 1px solid #E0E0E0; border-radius: 12px; margin-bottom: 12px; }
.sub-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
.idx-badge { background: #F1F3F4; padding: 2px 8px; border-radius: 6px; font-weight: bold; color: #5F6368; font-size: 12px; }
.time-input { width: 80px; padding: 4px; border: 1px solid #DADCE0; border-radius: 4px; text-align: center; font-family: monospace; font-size: 13px; }
.sub-text-block { margin-bottom: 8px; }
.sub-label { display: inline-block; font-size: 10px; font-weight: 700; color: #188038; background: #E6F4EA; padding: 2px 4px; border-radius: 4px; margin-bottom: 4px; }
.sub-label.secondary { color: #1967D2; background: #E8F0FE; }
.sub-line { width: 100%; padding: 8px; border: 1px solid #eee; border-radius: 4px; font-size: 15px; resize: vertical; min-height: 40px; }
.sub-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
.action-btn { width: 100%; padding: 10px 0; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.btn-play-sm { background: #E8F0FE; color: var(--primary); }
.btn-split { background: #FEF7E0; color: #E37400; }
.btn-merge { background: #E6F4EA; color: #137333; }
.btn-del { background: #FCE8E6; color: #C5221F; flex: none; }

/* é€šç”¨ç»„ä»¶ */
.audio-status { font-size: 13px; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; }
.audio-status.warn { background: #FCE8E6; color: #C5221F; }
.audio-status.ok { background: #E6F4EA; color: #137333; }
.input-tabs { display: flex; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
.tab-btn { padding: 8px 12px; font-size: 14px; color: #5F6368; cursor: pointer; border-radius: 6px; font-weight: 500; }
.tab-btn.active { background: #E8F0FE; color: var(--primary); }
.input-group { display: none; }
.input-group.active { display: block; }
.url-block { margin-bottom: 15px; }
.url-label { font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; display: block; }
.url-input { width: 100%; padding: 12px; border: 1px solid #DADCE0; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
.url-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,115,232,0.2); }
.history-select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }
.btn-load-url { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
.btn-load-url:disabled { background: #ccc; cursor: not-allowed; }
.loading-spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite; display: none; }
.file-box { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
.btn-file { flex: 1; min-width: 100px; background: #F1F3F4; padding: 12px; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; position: relative; }
.btn-file input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; }
.btn-file.primary { background: #E8F0FE; color: var(--primary); }
.btn-file.green { background: #E6F4EA; color: #137333; }
.slider-row { display: flex; align-items: center; gap: 10px; background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 15px; }
.btn-mini { padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }

/* Drawer */
.drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; display: none; }
.drawer-overlay.open { display: block; }
.drawer-content { width: 80%; max-width: 300px; height: 100%; background: #fff; padding: 24px; position: absolute; left: 0; top: 0; transform: translateX(-100%); transition: 0.3s; z-index: 501; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
.drawer-overlay.open .drawer-content { transform: translateX(0); }

.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #323232; color: white; padding: 12px 24px; border-radius: 24px; font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999; text-align: center; width: max-content; max-width: 80%; }
.toast.show { opacity: 1; bottom: 100px; }
.restore-bar { background: #FFF3E0; color: #B06000; padding: 12px; text-align: center; font-size: 14px; display: none; cursor: pointer; border-bottom: 1px solid #FEEFC3; font-weight: 500; }

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="restore-bar" class="restore-bar" onclick="app.restoreProgress()">
 å‘ç°ä¸Šæ¬¡è¿›åº¦ (ç¬¬<span id="restore-idx">1</span>å¥)ï¼Œç‚¹å‡»æ¢å¤
</div>
<div class="navbar">
<div class="nav-title">ğŸ§ å½±å­è·Ÿè¯» V64</div>
<div class="mode-switch">
<button class="mode-btn active" onclick="app.switchView('editor')">ç¼–è¾‘</button>
<button class="mode-btn" onclick="app.switchView('practice')">ç»ƒä¹ </button>
</div>
</div>
<audio id="main-audio" crossorigin="anonymous"></audio>
<audio id="record-audio"></audio>
<div class="view-container">
<div id="editor-view">
<div class="card">
<div id="audio-status-msg" class="audio-status"></div>
<div class="input-tabs">
<div class="tab-btn active" onclick="ui.setTab('url')">ğŸŒ ç½‘ç»œé“¾æ¥</div>
<div class="tab-btn" onclick="ui.setTab('local')">ğŸ“‚ æœ¬åœ°æ–‡ä»¶</div>
</div>
<div id="group-url" class="input-group active">
<select id="history-select" class="history-select" style="width:100%" onchange="app.fillHistory(this.value)">
<option value="">â–¼ é€‰æ‹©å†å²è®°å½•...</option>
</select>

<div class="url-block">
<label class="url-label">ğŸµ éŸ³é¢‘é“¾æ¥ (æ™ºèƒ½ç²˜è´´å¤šé“¾æ¥)</label>
<input type="text" class="url-input" id="url-audio" placeholder="åœ¨æ­¤ç²˜è´´ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«åˆ†é…..." onchange="app.saveInput()">
</div>
<div class="url-block">
<label class="url-label">ğŸ“„ å­—å¹•é“¾æ¥ (ä»»æ„ä¸€æ¡å³å¯)</label>
<input type="text" class="url-input" id="url-srt-1" placeholder="å­—å¹• 1 (Eng)" onchange="app.saveInput()">
<input type="text" class="url-input" style="margin-top:6px" id="url-srt-2" placeholder="å­—å¹• 2 (Eng+Chs)" onchange="app.saveInput()">
<input type="text" class="url-input" style="margin-top:6px" id="url-srt-3" placeholder="å­—å¹• 3 (Chs)" onchange="app.saveInput()">
</div>
<button class="btn-load-url" id="btn-load-url" onclick="app.loadFromUrl()">
<span class="loading-spinner" id="url-spinner"></span> ğŸš€ æé€ŸåŠ è½½
</button>
</div>
<div id="group-local" class="input-group">
<div class="file-box">
<div class="btn-file primary">ğŸµ å¯¼å…¥ MP3 <input type="file" id="audio-file" accept="audio/*"></div>
<div class="btn-file sub-slot">ğŸ“„ å­—å¹• 1 <input type="file" onchange="app.importSub(this, 0)" accept=".srt,.txt"></div>
<div class="btn-file sub-slot">ğŸ“„ å­—å¹• 2 <input type="file" onchange="app.importSub(this, 1)" accept=".srt,.txt"></div>
<div class="btn-file sub-slot">ğŸ“„ å­—å¹• 3 <input type="file" onchange="app.importSub(this, 2)" accept=".srt,.txt"></div>
</div>
</div>
<div class="file-box" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
<button class="btn-file" onclick="app.exportProject()">ğŸ’¾ ä¿å­˜å·¥ç¨‹</button>
<div class="btn-file">ğŸ“‚ åŠ è½½å·¥ç¨‹ <input type="file" id="project-file" accept=".json" onclick="this.value=null"></div>
</div>
<div class="file-box">
<button class="btn-file green" onclick="app.exportSRT(1)">â¬‡ å¯¼å‡ºå­—å¹•1</button>
<button class="btn-file green" onclick="app.exportSRT(2)">â¬‡ å¯¼å‡ºå­—å¹•2</button>
<button class="btn-file green" onclick="app.exportSRT(3)">â¬‡ å¯¼å‡ºå­—å¹•3</button>
</div>
<div class="slider-row">
<span style="font-size:13px; font-weight:600; color:#555">âœ‚ æ–­å¥çµæ•åº¦:</span>
<input type="range" id="threshold-range" min="0.01" max="0.1" step="0.01" value="0.02" style="flex:1" oninput="ui.updateThresh(this.value)">
<span id="threshold-val" style="font-family:monospace; font-size:12px;">0.02</span>
<button class="btn-mini" onclick="app.applyReAnalyze()">æ‰§è¡Œ</button>
</div>
<div style="text-align:center; margin-top:10px; font-size:12px; color:#666">å…± <span id="row-count">0</span> å¥</div>
</div>
<div id="editor-list"></div>
<div style="text-align:center; padding:20px;">
<button class="btn-file" style="display:inline-flex; width:auto; border:1px dashed #ccc;" onclick="app.addNewRow()">+ æ·»åŠ ç©ºè¡Œ</button>
</div>
</div>
<div id="practice-view">
<div class="practice-card">
<div id="drawer-overlay" class="drawer-overlay" onclick="ui.toggleDrawer()">
<div class="drawer-content" onclick="event.stopPropagation()">
<h3>âš™ èœå•</h3>
<button class="btn-file" onclick="app.exportProject()">ğŸ’¾ å¤‡ä»½å·¥ç¨‹</button>
<button class="btn-file" onclick="app.exportSRT(1)">â¬‡ å¯¼å‡ºå­—å¹•1</button>
<button class="btn-file" style="margin-top:10px" onclick="ui.toggleDrawer()">å…³é—­</button>
</div>
</div>
<div class="practice-header">
<div class="icon-btn" onclick="ui.toggleDrawer()">â˜°</div>
<div class="jump-select-wrapper">
<select id="jump-select" class="jump-select" onchange="app.jumpTo(this.value)"><option>1</option></select>
</div>
<div class="header-right-group">
<div class="sleep-wrapper">
<div class="icon-btn" onclick="ui.toggleSleepModal()">â°</div>
<div id="sleep-display" class="sleep-display"></div>
<div id="sleep-popup" class="sleep-popup">
<div style="font-size:12px;color:#666;margin-bottom:5px;">å®šæ—¶å…³é—­ (åˆ†é’Ÿ)</div>
<div style="display:flex;gap:5px;">
<input type="number" id="sleep-input" value="30" min="1" max="100" style="width:60px;padding:4px;border:1px solid #ddd;border-radius:4px;">
<button class="btn-mini" onclick="app.startSleepTimer()">å¼€å§‹</button>
</div>
</div>
</div>
<div id="text-toggle-btn" class="text-toggle" onclick="ui.toggleTextBlur()">ğŸ‘ æ˜¾ç¤º</div>
</div>
</div>
<div class="sub-switcher">
<button class="sub-btn active" onclick="ui.switchSubTab(0)">å­—å¹•1</button>
<button class="sub-btn" onclick="ui.switchSubTab(1)">å­—å¹•2</button>
<button class="sub-btn" onclick="ui.switchSubTab(2)">å­—å¹•3</button>
</div>
<div class="practice-text-container" onclick="ui.toggleTextBlur()">
<div id="practice-text-display" class="practice-text blur">(è¯·åŠ è½½å†…å®¹)</div>
<div id="click-hint" class="click-hint">ğŸ‘† ç‚¹å‡»åˆ‡æ¢æ˜¾éš</div>
</div>
<div class="control-area">
<div class="row-mixed">
<button class="btn-full-play" id="btn-full-play" onclick="engine.toggleFullPlay()">ğŸ§ å…¨æ–‡ç£¨è€³æœµ</button>
<div class="range-panel">
<span class="range-label">é¡µç :</span>
<input type="number" id="loop-start" class="range-input" value="1">
<span>-</span>
<input type="number" id="loop-end" class="range-input" value="10">
<button class="btn-range-play" id="btn-range-play" onclick="engine.toggleRangeLoop()">å¾ªç¯</button>
</div>
</div>
<div class="row-dual">
<button class="btn-action btn-blue" id="btn-play-once" onclick="engine.playOnce()">â–¶ æ’­å•å¥</button>
<button class="btn-action btn-orange" id="btn-loop" onclick="engine.toggleLoop()">ğŸ” å¾ªç¯å•å¥</button>
</div>
<button class="btn-record" id="btn-record" onclick="recorder.toggle()">ğŸ¤ æŒ‰ä¸‹å¼€å§‹å½•éŸ³</button>
<div class="row-dual">
<button class="btn-action btn-nav" onclick="app.prev()">â¬… ä¸Šä¸€å¥</button>
<button class="btn-action btn-nav" onclick="app.next()">ä¸‹ä¸€å¥ â¡</button>
</div>
</div>
</div>
</div>
</div>
<div id="toast" class="toast">æç¤º</div>
<script>
const CONST = { STORAGE: 'shadow_v50_data', INDEX: 'shadow_v50_idx', HIST: 'shadow_v50_hist', INPUTS: 'shadow_v50_inputs', 
PROXY: ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='] };
const state = { segments: [], currIndex: 0, activeSub: 0, audioBuffer: null, userBlurState: true, hasShownHint: false };
let hintTimer = null;





const net = {
    fixUrl(url) {
        if (!url) return '';
        url = url.trim();
        if (url.includes('gitee.com') && (url.includes('/edit/') || url.includes('/blob/'))) 
            return url.replace(/\/edit\/|\/blob\//, '/raw/');
        if (url.includes('github.com') && url.includes('/blob/')) 
            return url.replace('/blob/', '/raw/').replace('github.com', 'raw.githubusercontent.com');
        return url;
    },

    fetchWithTimeout(url, timeout) {
        return Promise.race([
            fetch(url),
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout)
            )
        ]);
    },

    async fetchCommon(url, type) {
        // ç›´è¿å°è¯•ï¼š30ç§’è¶…æ—¶
        ui.setLoadBtnText("æ­£åœ¨ç›´è¿ä¸‹è½½(è€å¿ƒç­‰å¾…)...");
        try {
            const res = await this.fetchWithTimeout(url, 30000); 
            if (res.ok) return type === 'blob' ? await res.blob() : await res.text();
            throw new Error("ç›´è¿å“åº”é”™è¯¯");
        } catch (e) { 
            console.warn("ç›´è¿å¤±è´¥ï¼Œå‡†å¤‡åˆ‡æ¢ä»£ç†:", e); 
        }

        // ä»£ç†å°è¯•ï¼š10ç§’è¶…æ—¶
        ui.setLoadBtnText("ç›´è¿è¶…æ—¶ï¼Œå°è¯•ä»£ç†...");
        for (const proxy of CONST.PROXY) {
            try {
                const res = await this.fetchWithTimeout(proxy + encodeURIComponent(url), 10000);
                if (res.ok) return type === 'blob' ? await res.blob() : await res.text();
            } catch (e) {}
        }
        throw new Error("ä¸‹è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼Œæˆ–ç½‘ç»œæ˜¯å¦é€šç•…ã€‚");
    },
    
    async fetchBlobSmart(url) { return this.fetchCommon(url, 'blob'); },
    async fetchTextSmart(url) { return this.fetchCommon(url, 'text'); }
};








const engine = {
    blobUrl: null,
    playSessionId: 0,
    
    // --- V64 æ ¸å¿ƒï¼šæ„å›¾é” ---
    // true = æ­£åœ¨å¤„ç†åŠ è½½/é”€æ¯/è·³è½¬ï¼Œæ‹’ç»ä¸€åˆ‡æ–°æŒ‡ä»¤
    isPending: false, 

    mode: 'IDLE',
    reqId: null,
    targetEnd: 0,
    
    activeDisposable: null, 
    disposableTimer: null,

    startTicker() {
        if (this.reqId) cancelAnimationFrame(this.reqId);
        this.tick();
    },

    stopAll(releaseMic = false) {
        this.playSessionId++; 
        this.mode = 'IDLE';
        
        // 1. ç‰©ç†åœæ­¢é•¿éŸ³é¢‘
        const a = document.getElementById('main-audio');
        if (a) { 
            a.pause(); 
            a.loop = false; 
        }
        if (this.reqId) cancelAnimationFrame(this.reqId);

        // 2. ç‰©ç†é”€æ¯çŸ­éŸ³é¢‘
        if (this.activeDisposable) {
            this.activeDisposable.pause();
            this.activeDisposable.src = ""; 
            this.activeDisposable = null;
        }
        if (this.disposableTimer) clearTimeout(this.disposableTimer);

        // 3. å…¶ä»–æ¸…ç†
        const r = document.getElementById('record-audio');
        if (r) r.pause();
        if (typeof recorder !== 'undefined') recorder.stop(releaseMic);
        
        // ã€å…³é”®ã€‘å¼ºåˆ¶è§£é”ï¼Œé˜²æ­¢æ­»é”
        this.isPending = false;
        
        ui.resetButtons();
    },

    // --- æ’­æ”¾æ€»å…¥å£ ---
    async playRange(start, end, newMode) {
        // ã€V64 æŠ¤æ ã€‘å¦‚æœå¼•æ“æ­£åœ¨å¿™ï¼ˆæ¯”å¦‚ä¸Šä¸€ä¸ª play è¿˜æ²¡è¿”å›ï¼‰ï¼Œç›´æ¥æ‹’ç»
        // è¿™èƒ½ä¿æŠ¤ iOS è„†å¼±çš„éŸ³é¢‘é€šé“ä¸è¢«å¡çˆ†
        if (this.isPending) {
            console.log("Engine busy, ignoring request");
            return;
        }
        
        // ä¸Šé”
        this.isPending = true;

        try {
            // 1. åœæ­¢æ—§çš„ä¸€åˆ‡ï¼Œç”Ÿæˆæ–°ä»¤ç‰Œ
            // æ³¨æ„ï¼šstopAll ä¼šé‡ç½® isPending ä¸º falseï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰‹åŠ¨ä¿æŒ true
            this.stopAll(); 
            this.isPending = true; // å†æ¬¡ä¸Šé”ï¼Œå› ä¸º stopAll è§£é”äº†

            const mySession = this.playSessionId;

            if (!this.blobUrl) {
                ui.toast("éŸ³é¢‘æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡æ–°åŠ è½½");
                return;
            }

            this.mode = newMode;
            const duration = end - start;
            
            // 2. æˆ˜ç•¥åˆ†æµ
            if (duration < 2.0 && newMode !== 'FULL_PLAY') {
                await this.playShortClip(start, duration, mySession);
            } else {
                await this.playLongClip(start, end, mySession);
            }

        } catch (e) {
            console.error(e);
            ui.toast("æ“ä½œè¿‡å¿«æˆ–å‡ºé”™");
        } finally {
            // 3. ã€å…³é”®ã€‘æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæ“ä½œç»“æŸï¼Œè§£é”
            // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œç»™ iOS å–˜æ¯æ—¶é—´
            setTimeout(() => { this.isPending = false; }, 50);
        }
    },

    // --- åˆ†æ”¯ A: çŸ­éŸ³é¢‘ ---
    async playShortClip(start, duration, session) {
        console.log(`[${session}] çŸ­éŸ³é¢‘å¯åŠ¨`);
        
        const audio = new Audio(this.blobUrl);
        this.activeDisposable = audio;
        audio.currentTime = start;
        
        try {
            // ç­‰å¾…ç¡¬ä»¶çœŸæ­£å¼€å§‹æ’­æ”¾
            await audio.play();
            
            // å¦‚æœç­‰å¾…æœŸé—´ç”¨æˆ·ç‚¹äº†åœæ­¢ï¼ˆSession å˜äº†ï¼‰ï¼Œç«‹å³è‡ªæ¯
            if (this.playSessionId !== session) {
                audio.pause(); audio.src = ""; return;
            }

            this.updateButtonUI(this.mode);

            // è®¾ç½®ç»“æŸå®šæ—¶å™¨
            const playTime = (duration + 0.35) * 1000;
            this.disposableTimer = setTimeout(() => {
                if (this.playSessionId === session) {
                    this.finishShortPlayback();
                }
            }, playTime);

        } catch (e) {
            if (e.name === 'NotAllowedError') ui.toast("è¯·ç‚¹å‡»æŒ‰é’®æ’­æ”¾");
            throw e; // æŠ›å‡ºé”™è¯¯ç»™ playRange çš„ catch å¤„ç†
        }
    },

    finishShortPlayback() {
        // é”€æ¯
        if (this.activeDisposable) {
            this.activeDisposable.pause();
            this.activeDisposable = null;
        }
        
        // é€»è¾‘æµè½¬
        if (this.mode === 'PLAY_ONCE') {
            this.stopAll(); 
        } 
        else if (this.mode === 'LOOP_ONE') {
            // å•å¥å¾ªç¯ï¼šå¿…é¡»ç­‰ isPending è§£é”åæ‰èƒ½è§¦å‘ä¸‹ä¸€æ¬¡
            // å› ä¸º finishShortPlayback æ˜¯å®šæ—¶å™¨è§¦å‘çš„ï¼Œæ­¤æ—¶ isPending åº”è¯¥æ˜¯ false
            const seg = state.segments[state.currIndex];
            if (seg) this.playRange(seg.start, seg.end, 'LOOP_ONE');
        } 
        else if (this.mode === 'LOOP_RANGE') {
            this.triggerNextRange();
        }
    },

    // --- åˆ†æ”¯ B: é•¿éŸ³é¢‘ ---
    async playLongClip(start, end, session) {
        console.log(`[${session}] é•¿éŸ³é¢‘å¯åŠ¨`);
        const a = document.getElementById('main-audio');
        this.targetEnd = end;

        try {
            a.currentTime = start;
            await a.play();
            
            if (this.playSessionId !== session) return;

            this.startTicker();
            this.updateButtonUI(this.mode);
        } catch (e) {
            if (e.name === 'NotAllowedError') ui.toast("è¯·ç‚¹å‡»æŒ‰é’®æ’­æ”¾");
            throw e;
        }
    },

    tick() {
        this.reqId = requestAnimationFrame(() => this.tick());
        const a = document.getElementById('main-audio');
        if (a.paused) return;

        const ct = a.currentTime;

        if (this.mode === 'FULL_PLAY') {
            const activeIdx = state.segments.findIndex(s => ct >= s.start && ct < s.end);
            if (activeIdx !== -1 && activeIdx !== state.currIndex) {
                state.currIndex = activeIdx;
                ui.updatePractice(activeIdx);
            }
            if (a.ended) { 
                a.currentTime = 0; a.play(); 
                state.currIndex = 0; ui.updatePractice(0); 
            }
            return;
        }

        if (ct >= this.targetEnd) {
            this.finishLongPlayback();
        }
    },

    finishLongPlayback() {
        const a = document.getElementById('main-audio');
        a.pause();
        
        if (this.mode === 'PLAY_ONCE') {
            this.stopAll();
        } else if (this.mode === 'LOOP_ONE') {
            const seg = state.segments[state.currIndex];
            this.playRange(seg.start, seg.end, 'LOOP_ONE');
        } else if (this.mode === 'LOOP_RANGE') {
            this.triggerNextRange();
        }
    },

    triggerNextRange() {
        const endLimit = parseInt(document.getElementById('loop-end').value) - 1;
        const startLimit = parseInt(document.getElementById('loop-start').value) - 1;
        
        let nextIdx = state.currIndex + 1;
        if (nextIdx > endLimit || nextIdx >= state.segments.length) {
            nextIdx = Math.max(0, startLimit);
        }
        
        state.currIndex = nextIdx;
        ui.updatePractice(nextIdx);
        
        const seg = state.segments[nextIdx];
        this.playRange(seg.start, seg.end, 'LOOP_RANGE');
    },

    updateButtonUI(m) {
        ui.resetButtons();
        if (m === 'PLAY_ONCE') document.getElementById('btn-play-once').classList.add('active');
        if (m === 'LOOP_ONE') document.getElementById('btn-loop').classList.add('active');
        if (m === 'LOOP_RANGE') {
            const b = document.getElementById('btn-range-play');
            b.classList.add('active');
            b.innerText = "â¸";
        }
        if (m === 'FULL_PLAY') {
            const b = document.getElementById('btn-full-play');
            b.classList.add('active');
            b.innerText = " â¸ åœæ­¢";
        }
    },

    playSegment(i) {
        if (!state.segments[i]) return;
        this.playRange(state.segments[i].start, state.segments[i].end, 'PLAY_ONCE');
    },
    playOnce() {
        if (!this.check()) return;
        const seg = state.segments[state.currIndex];
        this.playRange(seg.start, seg.end, 'PLAY_ONCE');
    },
    toggleLoop() {
        if (this.mode === 'LOOP_ONE') this.stopAll();
        else {
            if (!this.check()) return;
            const seg = state.segments[state.currIndex];
            this.playRange(seg.start, seg.end, 'LOOP_ONE');
        }
    },
    toggleRangeLoop() {
        if (this.mode === 'LOOP_RANGE') this.stopAll();
        else {
            if (!state.segments.length) return ui.toast("æ— å†…å®¹");
            const start = Math.max(0, parseInt(document.getElementById('loop-start').value) - 1);
            state.currIndex = start;
            ui.updatePractice(start);
            const seg = state.segments[start];
            this.playRange(seg.start, seg.end, 'LOOP_RANGE');
        }
    },
    toggleFullPlay() {
        if (this.mode === 'FULL_PLAY') this.stopAll();
        else {
            if (!this.check()) return;
            this.playRange(0, 999999, 'FULL_PLAY');
        }
    },
    check() {
        if (!state.segments.length) { ui.toast("è¯·å…ˆåŠ è½½å†…å®¹"); return false; }
        if (!this.blobUrl) { ui.toast("éŸ³é¢‘æœªå°±ç»ª"); return false; }
        return true;
    }
};








const ui = {
    init() {
        // å°†æ™ºèƒ½è¾“å…¥é€»è¾‘ç»‘å®šåˆ°æ‰€æœ‰ URL è¾“å…¥æ¡†
        this.attachSmartInput('url-audio', true); // true è¡¨ç¤ºè¿™æ˜¯ä¸»éŸ³é¢‘æ¡†
        this.attachSmartInput('url-srt-1', false);
        this.attachSmartInput('url-srt-2', false);
        this.attachSmartInput('url-srt-3', false);

        // æ¢å¤ä¹‹å‰çš„çŠ¶æ€
        const p = new URLSearchParams(location.search);
        if (p.get('mp3')) {
            document.getElementById('url-audio').value = p.get('mp3');
            if (p.get('srt')) document.getElementById('url-srt-1').value = p.get('srt');
            setTimeout(() => app.loadFromUrl(), 500);
        } else {
            const inputs = JSON.parse(localStorage.getItem(CONST.INPUTS) || '{}');
            if (inputs.mp3) document.getElementById('url-audio').value = inputs.mp3;
            if (inputs.s1) document.getElementById('url-srt-1').value = inputs.s1;
            if (inputs.s2) document.getElementById('url-srt-2').value = inputs.s2;
            if (inputs.s3) document.getElementById('url-srt-3').value = inputs.s3;
        }
        
        this.renderHistory();
        const d = localStorage.getItem(CONST.STORAGE);

        if (d && JSON.parse(d).length) {
            state.segments = JSON.parse(d);
            state.currIndex = parseInt(localStorage.getItem(CONST.INDEX) || 0);
            this.renderEditor();
            this.updatePractice(state.currIndex);
            document.getElementById('restore-idx').innerText = state.currIndex + 1;
            document.getElementById('restore-bar').style.display = 'block';
        }
        this.updateAudioStatus();
    },

    // ã€æ–°åŠŸèƒ½ã€‘å°è£…çš„æ™ºèƒ½è¾“å…¥å¤„ç†å™¨
    attachSmartInput(id, isMaster) {
        const el = document.getElementById(id);
        if (!el) return;

        // 1. ç›‘å¬ç²˜è´´äº‹ä»¶ (å¤„ç†æ™ºèƒ½è¯†åˆ«)
        el.addEventListener('paste', (e) => {
            // è·å–ç²˜è´´æ¿æ–‡å­—
            const text = (e.clipboardData || window.clipboardData).getData('text');
            if (!text) return;

            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœåŒ…å« mp3 æˆ–è€…åŒ…å«æ¢è¡Œ/å¤šä¸ªé“¾æ¥ï¼Œå°±å°è¯•äº¤ç»™ app å¤„ç†
            // å¦åˆ™è®©æµè§ˆå™¨æ‰§è¡Œé»˜è®¤çš„å•è¡Œç²˜è´´
            if (text.includes('.mp3') || (text.match(/http/g) || []).length > 1) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤ç²˜è´´ï¼Œç”± app å…¨æƒæ¥ç®¡
                app.handleSmartPaste(e);
            }
            // å¦‚æœåªæ˜¯æ™®é€šçŸ­é“¾ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œè®©æµè§ˆå™¨è‡ªç„¶ç²˜è´´è¿›å»
        });

        // 2. ç›‘å¬èšç„¦äº‹ä»¶ (å¤„ç†è‡ªåŠ¨æ¸…ç©º)
        el.addEventListener('focus', function() {
            // ä¸ºäº†é˜²æ­¢å’Œâ€œç‚¹å‡»ç²˜è´´â€å†²çªï¼Œè¿™é‡Œåšä¸€ä¸ªå¾®å°çš„åˆ¤æ–­
            // å¦‚æœæ˜¯ä¸»éŸ³é¢‘æ¡†(isMaster)ï¼Œæ¸…ç©ºæ‰€æœ‰ï¼›å¦åˆ™åªæ¸…ç©ºè‡ªå·±
            this.value = '';
            if (isMaster) {
                ['url-srt-1', 'url-srt-2', 'url-srt-3'].forEach(sid => {
                    const sel = document.getElementById(sid);
                    if (sel) sel.value = '';
                });
            }
        });
    },

    renderHistory() {
        const h = JSON.parse(localStorage.getItem(CONST.HIST) || '[]');
        const sel = document.getElementById('history-select');
        sel.innerHTML = '<option value="">â–¼ é€‰æ‹©å†å²è®°å½•...</option>';
        h.forEach((item, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = item.name;
            sel.appendChild(opt);
        });
    },
    
    setTab(t) {
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', (t === 'url' && i === 0) || (t === 'local' && i === 1)));
        document.getElementById('group-url').style.display = t === 'url' ? 'block' : 'none';
        document.getElementById('group-local').style.display = t === 'local' ? 'block' : 'none';
    },

    setLoadBtnText(t) {
        document.getElementById('btn-load-url').innerHTML = t === "default" ? '<span class="loading-spinner" id="url-spinner"></span>  æé€ŸåŠ è½½' : t;
    },

    updateThresh(v) {
        document.getElementById('threshold-val').innerText = v;
    },

    toast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    },

    updateAudioStatus() {
        const m = document.getElementById('audio-status-msg');
        const a = document.getElementById('main-audio');
        if (a.src && a.src !== location.href) {
            m.className = 'audio-status ok';
            m.style.display = 'block';
            m.innerText = " âœ… éŸ³é¢‘å·²å°±ç»ª";
            setTimeout(() => m.style.display = 'none', 3000);
        } else {
            m.className = 'audio-status warn';
            m.style.display = 'block';
            m.innerText = " âš  éŸ³é¢‘æœªå°±ç»ª";
        }
    },

    resetButtons() {
        document.getElementById('btn-play-once').classList.remove('active');
        document.getElementById('btn-loop').classList.remove('active');
        const rangeBtn = document.getElementById('btn-range-play');
        rangeBtn.classList.remove('active');
        rangeBtn.innerText = "å¾ªç¯";
        const fullBtn = document.getElementById('btn-full-play');
        fullBtn.classList.remove('active');
        fullBtn.innerText = "  å…¨æ–‡ç£¨è€³æœµ";
        const recBtn = document.getElementById('btn-record');
        recBtn.classList.remove('recording', 'playing');
        recBtn.innerText = "  æŒ‰ä¸‹å¼€å§‹å½•éŸ³";
    },

    renderEditor() {
        const l = document.getElementById('editor-list');
        l.innerHTML = '';
        document.getElementById('row-count').innerText = state.segments.length;
        state.segments.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'sub-item';
            d.innerHTML = `
 <div class="sub-meta"><span class="idx-badge">#${i+1}</span><div class="time-edit-group"><input type="number" class="time-input" value="${s.start.toFixed(2)}" step="0.1" onchange="app.updateSeg(${i},'start',this.value)"> - <input type="number" class="time-input" value="${s.end.toFixed(2)}" step="0.1" onchange="app.updateSeg(${i},'end',this.value)"></div></div>
 ${s.text !== undefined ? `<div class="sub-text-block"><span class="sub-label">SUB 1</span><textarea class="sub-line" onchange="app.updateSeg(${i},'text',this.value)">${s.text}</textarea></div>` : ''}
 ${s.text2 !== undefined ? `<div class="sub-text-block"><span class="sub-label secondary">SUB 2</span><textarea class="sub-line" onchange="app.updateSeg(${i},'text2',this.value)">${s.text2}</textarea></div>` : ''}
 ${s.text3 !== undefined ? `<div class="sub-text-block"><span class="sub-label secondary">SUB 3</span><textarea class="sub-line" onchange="app.updateSeg(${i},'text3',this.value)">${s.text3}</textarea></div>` : ''}
 <div class="sub-actions"><button class="action-btn btn-play-sm" onclick="engine.playSegment(${i})"> â–¶ è¯•å¬</button><button class="action-btn btn-split" onclick="app.splitSeg(${i})"> âœ‚ æ‹†åˆ†</button><button class="action-btn btn-merge" onclick="app.mergeSeg(${i})"> åˆå¹¶</button><button class="action-btn btn-del" onclick="app.delSeg(${i})"> âœ• åˆ é™¤</button></div>`;
            l.appendChild(d);
        });
        document.getElementById('loop-start').max = state.segments.length;
        document.getElementById('loop-end').max = state.segments.length;
        document.getElementById('loop-end').value = state.segments.length;
        
        const sel = document.getElementById('jump-select');
        sel.innerHTML = '';
        state.segments.forEach((_, i) => {
            const o = document.createElement('option');
            o.value = i;
            o.text = `ç¬¬ ${i+1} å¥`;
            sel.appendChild(o);
        });
        app.save();
    },

    updatePractice(idx) {
        if (!state.segments[idx]) return;
        const key = state.activeSub === 1 ? 'text2' : (state.activeSub === 2 ? 'text3' : 'text');
        const txt = document.getElementById('practice-text-display');
        const content = state.segments[idx][key] || "(æ— å†…å®¹)";
        txt.innerText = content;
        this.fitText(txt);
        if (state.userBlurState) {
            txt.classList.add("blur");
            document.getElementById('text-toggle-btn').innerText = "  æ˜¾ç¤º";
        } else {
            txt.classList.remove("blur");
            document.getElementById('text-toggle-btn').innerText = "  éšè—";
        }
        if (content === "(æ— å†…å®¹)") txt.className = "practice-text empty";
        document.getElementById('jump-select').value = idx;
        if (!state.hasShownHint) {
            const hint = document.getElementById('click-hint');
            hint.classList.add('show');
            setTimeout(() => {
                hint.classList.remove('show');
                state.hasShownHint = true;
            }, 3000);
        }
    },

    showHintManual() {
        const hint = document.getElementById('click-hint');
        hint.classList.add('show');
        setTimeout(() => hint.classList.remove('show'), 3000);
    },

    fitText(el) {
        let size = 34;
        el.style.fontSize = size + 'px';
        while (el.scrollHeight > el.parentElement.clientHeight && size > 16) {
            size--;
            el.style.fontSize = size + 'px';
        }
    },

    toggleTextBlur() {
        state.userBlurState = !state.userBlurState;
        ui.updatePractice(state.currIndex);
        ui.showHintManual();
    },

    switchSubTab(i) {
        state.activeSub = i;
        document.querySelectorAll('.sub-btn').forEach((b, k) => b.classList.toggle('active', k === i));
        ui.updatePractice(state.currIndex);
    },

    toggleDrawer() {
        document.getElementById('drawer-overlay').classList.toggle('open');
    },

    toggleSleepModal() {
        const popup = document.getElementById('sleep-popup');
        popup.classList.toggle('show');
    }
};








const app = {
    handleSmartPaste(e) {
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if (!text) return;
        
        if (text.match(/https?:\/\//g).length > 1 || text.includes('.mp3')) {
            e.preventDefault();
            document.getElementById('url-audio').value = '';
            document.getElementById('url-srt-1').value = '';
            document.getElementById('url-srt-2').value = '';
            document.getElementById('url-srt-3').value = '';

            const mp3Match = text.match(/https?:\/\/[^\s"']+\.mp3/i);
            if (mp3Match) document.getElementById('url-audio').value = mp3Match[0];

            const srtEng = text.match(/https?:\/\/[^\s"']+(?<!engchs)\.eng\.srt/i);
            const srtEngChs = text.match(/https?:\/\/[^\s"']+\.engchs\.srt/i);
            const srtChs = text.match(/https?:\/\/[^\s"']+(?<!engchs)\.chs\.srt/i);

            if (srtEng) document.getElementById('url-srt-1').value = srtEng[0];
            if (srtEngChs) document.getElementById('url-srt-2').value = srtEngChs[0];
            if (srtChs) document.getElementById('url-srt-3').value = srtChs[0];

            this.saveInput();
            ui.toast("ğŸ“‹ æ™ºèƒ½ç²˜è´´ï¼šé“¾æ¥å·²åˆ†é…");
        }
    },

    sleepTimerId: null,
    sleepInterval: null,
    startSleepTimer() {
        const input = document.getElementById('sleep-input');
        const mins = parseInt(input.value);
        if (!mins || mins < 1 || mins > 100) return ui.toast("è¯·è¾“å…¥ 1-100");

        if (this.sleepTimerId) clearTimeout(this.sleepTimerId);
        if (this.sleepInterval) clearInterval(this.sleepInterval);
        
        const endTime = Date.now() + mins * 60 * 1000;
        ui.toggleSleepModal();
        const display = document.getElementById('sleep-display');
        display.style.display = 'block';

        const updateDisplay = () => {
            const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
            if (remaining <= 0) {
                display.innerText = "";
                display.style.display = "none";
                clearInterval(this.sleepInterval);
            } else {
                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                display.innerText = `â° ${m}:${s.toString().padStart(2, '0')}`;
            }
        };
        updateDisplay();
        this.sleepInterval = setInterval(updateDisplay, 1000);
        this.sleepTimerId = setTimeout(() => {
            engine.stopAll();
            ui.toast("ğŸ’¤ å®šæ—¶ç»“æŸï¼Œåœæ­¢æ’­æ”¾");
            display.style.display = 'none';
            clearInterval(this.sleepInterval);
        }, mins * 60 * 1000);
        ui.toast(`å€’è®¡æ—¶ ${mins} åˆ†é’Ÿå¼€å§‹`);
    },

    saveInput() {
        const d = { 
            mp3: document.getElementById('url-audio').value,
            s1: document.getElementById('url-srt-1').value,
            s2: document.getElementById('url-srt-2').value,
            s3: document.getElementById('url-srt-3').value 
        };
        localStorage.setItem(CONST.INPUTS, JSON.stringify(d));
    },

    addHistory(mp3, name) {
        let h = JSON.parse(localStorage.getItem(CONST.HIST) || '[]');
        h = h.filter(i => i.mp3 !== mp3);
        const d = JSON.parse(localStorage.getItem(CONST.INPUTS));
        h.unshift({ name: name || mp3.split('/').pop(), mp3, ...d });
        if (h.length > 10) h.pop();
        localStorage.setItem(CONST.HIST, JSON.stringify(h));
        ui.renderHistory();
    },

    fillHistory(i) {
        if (i === "") return;
        const h = JSON.parse(localStorage.getItem(CONST.HIST) || '[]');
        const item = h[i];
        if (item) {
            document.getElementById('url-audio').value = item.mp3;
            document.getElementById('url-srt-1').value = item.s1 || '';
            document.getElementById('url-srt-2').value = item.s2 || '';
            document.getElementById('url-srt-3').value = item.s3 || '';
            this.saveInput();
        }
    },

    async loadFromUrl() {
        state.segments = [];
        ui.renderEditor();
        this.saveInput();
        
        const mp3 = net.fixUrl(document.getElementById('url-audio').value.trim());
        const s1 = net.fixUrl(document.getElementById('url-srt-1').value.trim());
        const s2 = net.fixUrl(document.getElementById('url-srt-2').value.trim());
        const s3 = net.fixUrl(document.getElementById('url-srt-3').value.trim());

        if (!mp3) return ui.toast("è¯·è¾“å…¥ MP3 é“¾æ¥");

        const btn = document.getElementById('btn-load-url');
        const spin = document.getElementById('url-spinner');
        btn.disabled = true;
        spin.style.display = 'inline-block';

        try {
            ui.toast("æ­£åœ¨ä¸‹è½½éŸ³é¢‘(è¯·å‹¿é”å±)...");
            const audioBlob = await net.fetchBlobSmart(mp3);
            const blobUrl = URL.createObjectURL(audioBlob);
            
            // ä¿å­˜ Blob URL
            engine.blobUrl = blobUrl;
            
            const a = document.getElementById('main-audio');
            a.src = blobUrl;
            a.preload = "auto";
            a.load();

            ui.toast("âœ… éŸ³é¢‘ä¸‹è½½æˆåŠŸ! æ­£åœ¨è·å–å­—å¹•...");

            const loadTxt = async (u) => u ? await net.fetchTextSmart(u) : null;
            const [t1, t2, t3] = await Promise.all([loadTxt(s1), loadTxt(s2), loadTxt(s3)]);

            if (t1 || t2 || t3) {
                if (t1) {
                    state.segments = parseSRT(t1);
                    if (t2) this.mergeSub(parseSRT(t2), 'text2');
                    if (t3) this.mergeSub(parseSRT(t3), 'text3');
                } else if (t2) {
                    state.segments = parseSRT(t2).map(s => ({ start: s.start, end: s.end, text2: s.text }));
                    if (t3) this.mergeSub(parseSRT(t3), 'text3');
                } else {
                    state.segments = parseSRT(t3).map(s => ({ start: s.start, end: s.end, text3: s.text }));
                }
            } else {
                ui.toast("æ— å­—å¹•æ¨¡å¼ï¼Œæ­£åœ¨è¿›è¡Œé™éŸ³æ–­å¥...");
                await new Promise(r => setTimeout(r, 50));
                const ab = await audioBlob.arrayBuffer();
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                state.audioBuffer = await ctx.decodeAudioData(ab);
                state.segments = detectSilence(state.audioBuffer, 0.02);
                if (!state.segments.length) state.segments = [{ start: 0, end: state.audioBuffer.duration, text: "(è‡ªåŠ¨æ–­å¥å¤±è´¥)" }];
            }

            this.addHistory(mp3);
            ui.renderEditor();
            ui.updateAudioStatus();
            ui.toast("âœ… å…¨éƒ¨å°±ç»ªï¼Œæ­£åœ¨è·³è½¬...");
            app.switchView('practice');

        } catch (e) {
            console.error(e);
            ui.setLoadBtnText("åŠ è½½å¤±è´¥: " + e.message);
        } finally {
            btn.disabled = false;
            spin.style.display = 'none';
            setTimeout(() => ui.setLoadBtnText("default"), 3000);
        }
    },

    mergeSub(newS, k) {
        state.segments.forEach(b => {
            const m = newS.find(n => (n.start >= b.start && n.start < b.end));
            if (m) b[k] = m.text;
        });
    },

    switchView(v) {
        engine.stopAll();
        if (v === 'practice' && !state.segments.length) return ui.toast("è¯·å…ˆåŠ è½½å†…å®¹");

        document.getElementById('editor-view').style.display = v === 'editor' ? 'block' : 'none';
        const pView = document.getElementById('practice-view');
        pView.style.display = v === 'practice' ? 'flex' : 'none';
        if (v === 'practice') pView.classList.add('active');

        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(v)));
        
        if (v === 'practice') {
            state.currIndex = Math.min(state.currIndex, state.segments.length - 1);
            ui.updatePractice(state.currIndex);
        }
    },

    loadItem(i, playNow) {
        if (i < 0 || i >= state.segments.length) return;
        
        // ã€V64 æŠ¤æ ã€‘å¦‚æœå¼•æ“åœ¨å¿™ï¼Œä¸å…è®¸åˆ‡æ¢ï¼Œé˜²æ­¢ UI å’Œ Audio ä¸åŒæ­¥
        if (playNow && engine.isPending) {
            console.log("Input blocked: Engine busy");
            return;
        }

        state.currIndex = i;
        ui.updatePractice(i);
        app.save(); 

        if (playNow) {
            const seg = state.segments[i];
            engine.playRange(seg.start, seg.end, 'PLAY_ONCE');
        }
    },

    next() {
        if (state.currIndex < state.segments.length - 1) {
            state.userBlurState = true;
            this.loadItem(state.currIndex + 1, true);
        } else {
            ui.toast("å·²ç»æ˜¯æœ€åä¸€å¥");
        }
    },

    prev() {
        if (state.currIndex > 0) {
            state.userBlurState = true;
            this.loadItem(state.currIndex - 1, true);
        } else {
            ui.toast("å·²ç»æ˜¯ç¬¬ä¸€å¥");
        }
    },

    jumpTo(v) {
        this.loadItem(parseInt(v), true);
    },

    updateSeg(i, k, v) {
        if (k.startsWith('text')) state.segments[i][k] = v;
        else state.segments[i][k] = parseFloat(v);
        this.save();
    },

    delSeg(i) {
        state.segments.splice(i, 1);
        ui.renderEditor();
    },

    splitSeg(i) {
        const t = document.getElementById('main-audio').currentTime;
        if (t > state.segments[i].start && t < state.segments[i].end) {
            const old = state.segments[i];
            const newSeg = { start: t, end: old.end, text: "" };
            if (old.text2 !== undefined) newSeg.text2 = "";
            if (old.text3 !== undefined) newSeg.text3 = "";
            state.segments.splice(i + 1, 0, newSeg);
            state.segments[i].end = t;
            ui.renderEditor();
        } else ui.toast("è¯·åœ¨è¯•å¬æ—¶æš‚åœäºæ‹†åˆ†ç‚¹");
    },

    mergeSeg(i) {
        if (i < state.segments.length - 1) {
            state.segments[i].end = state.segments[i + 1].end;
            state.segments[i].text = (state.segments[i].text + " " + (state.segments[i + 1].text || "")).trim();
            if (state.segments[i].text2) state.segments[i].text2 += " " + (state.segments[i + 1].text2 || "");
            if (state.segments[i].text3) state.segments[i].text3 += " " + (state.segments[i + 1].text3 || "");
            state.segments.splice(i + 1, 1);
            ui.renderEditor();
        }
    },

    addNewRow() {
        const last = state.segments[state.segments.length - 1] || { end: 0 };
        const newObj = { start: last.end, end: last.end + 2, text: "" };
        if (last.text2 !== undefined) newObj.text2 = "";
        if (last.text3 !== undefined) newObj.text3 = "";
        state.segments.push(newObj);
        ui.renderEditor();
    },

    applyReAnalyze() {
        if (!state.audioBuffer) return ui.toast("éœ€å…ˆæˆåŠŸåŠ è½½éŸ³é¢‘æ•°æ®");
        const val = parseFloat(document.getElementById('threshold-range').value);
        state.segments = detectSilence(state.audioBuffer, val);
        ui.renderEditor();
        ui.toast("é‡æ–°åˆ†æå®Œæˆ");
    },

    save() {
        localStorage.setItem(CONST.STORAGE, JSON.stringify(state.segments));
        localStorage.setItem(CONST.INDEX, state.currIndex);
    },

    restoreProgress() {
        const d = localStorage.getItem(CONST.STORAGE);
        const i = localStorage.getItem(CONST.INDEX);
        if (d) {
            state.segments = JSON.parse(d);
            state.currIndex = parseInt(i) || 0;
            ui.renderEditor();
            document.getElementById('restore-bar').style.display = 'none';
            ui.updateAudioStatus();
            ui.toast("è¿›åº¦å·²æ¢å¤");
        }
    },

    exportProject() {
        const b = new Blob([JSON.stringify({ segments: state.segments, idx: state.currIndex })]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'shadow.json';
        a.click();
    },

    exportSRT(slot) {
        if (!state.segments.length) return ui.toast("æ— æ•°æ®");
        let key = 'text';
        if (slot === 2) key = 'text2';
        if (slot === 3) key = 'text3';
        
        if (!state.segments.some(s => s[key])) return ui.toast(`å­—å¹•${slot}æ— å†…å®¹`);
        
        let c = "";
        state.segments.forEach((s, i) => {
            c += `${i + 1}\n${fmtTime(s.start, 1)} --> ${fmtTime(s.end, 1)}\n${s[key] || ''}\n\n`;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([c], { type: 'text/plain' }));
        a.download = `sub_${slot}.srt`;
        a.click();
    },

    loadProject(el) {
        const f = el.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = e => {
            const d = JSON.parse(e.target.result);
            state.segments = d.segments || d;
            state.currIndex = d.idx || 0;
            ui.renderEditor();
            ui.updateAudioStatus();
            ui.toast("å·¥ç¨‹åŠ è½½æˆåŠŸ");
        };
        r.readAsText(f);
    },

    importSub(el, k) {
        const f = el.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = e => {
            const n = parseSRT(e.target.result);
            if (k === 0) state.segments = n;
            else app.mergeSub(n, k === 1 ? 'text2' : 'text3');
            ui.renderEditor();
        };
        r.readAsText(f);
    }
};










document.getElementById('project-file').addEventListener('change', e=>app.loadProject(e.target));

const recorder = {
    rec: null, chunks: [], stream: null, isRec: false,
    async toggle() {
        const btn = document.getElementById('btn-record');
        if(!this.isRec) {
            engine.stopAll();
            try {
                this.stream = await navigator.mediaDevices.getUserMedia({audio:true});
                this.rec = new MediaRecorder(this.stream); this.chunks = [];
                this.rec.ondataavailable = e => this.chunks.push(e.data);
                this.rec.onstop = () => { if(this.stream) this.stream.getTracks().forEach(t=>t.stop()); if(!this.forceStop) this.playCmp(); };
                this.rec.start(); this.isRec = true; btn.classList.add('recording'); btn.innerText="â¹ åœæ­¢å½•éŸ³";
            } catch(e) { alert("æ— éº¦å…‹é£æƒé™"); }
        } else { this.stop(false); }
    },
    stop(force) { if(this.isRec) { this.forceStop = force; this.rec.stop(); this.isRec = false; } document.getElementById('btn-record').classList.remove('recording'); document.getElementById('btn-record').innerText="ğŸ¤ æŒ‰ä¸‹å¼€å§‹å½•éŸ³"; },
    playCmp() {
        const s = state.segments[state.currIndex]; const a = document.getElementById('main-audio'); const r = document.getElementById('record-audio');
        const b = new Blob(this.chunks, {type:'audio/mp3'}); r.src = URL.createObjectURL(b);
        ui.toast("ğŸ§ åŸéŸ³"); a.currentTime = s.start; a.play();
        const timer = setInterval(() => {
            if(a.currentTime >= s.end) {
                a.pause(); clearInterval(timer);
                setTimeout(() => {
                    ui.toast("ğŸ‘¤ å½•éŸ³"); r.currentTime = 0; r.play();
                    r.onended = () => { document.getElementById('btn-record').classList.remove('playing'); ui.toast("æ’­æ”¾å®Œæ¯•"); };
                    document.getElementById('btn-record').classList.add('playing');
                }, 500);
            }
        }, 30);
    }
};
document.getElementById('audio-file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) { document.getElementById('main-audio').src=URL.createObjectURL(f); ui.updateAudioStatus(); } });
function fmtTime(s, srt=false) { const d=new Date(0); d.setMilliseconds(s*1000); const str=d.toISOString().substr(11, 12); return srt ? str.replace('.', ',') : str.substr(3, 8); }
function parseSRT(t) { const r=[]; const e=/(\d+)?\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})\s-->\s(\d{2}:\d{2}:\d{2}[,.]\d{3})\s+([\s\S]*?)(?=\n\d+\s+\d{2}:\d{2}|$)/g; let m; while(m=e.exec(t)) r.push({start:pt(m[2]), end:pt(m[3]), text:m[4].trim()}); return r; }
function pt(s){ s=s.replace(',','.'); const p=s.split(':'); return parseInt(p[0])*3600 + parseInt(p[1])*60 + parseFloat(p[2]); }
function detectSilence(b,th){const d=b.getChannelData(0),sr=b.sampleRate,min=0.4*sr;let res=[],sp=false,st=0,sil=0;for(let i=0;i<d.length;i+=200){if(Math.abs(d[i])>th){if(!sp){sp=true;st=i;}sil=0;}else if(sp){if(!sil)sil=i;if(i-sil>min){const s=st/sr,e=sil/sr;if(e-s>0.3)res.push({start:s,end:e,text:""});sp=false;sil=0;}}}if(sp)res.push({start:st/sr,end:d.length/sr,text:""});return res;}
ui.init();
</script>
</body>
</html>