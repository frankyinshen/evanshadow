<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å½±å­è·Ÿè¯» Pro V38 (UIå®Œç¾é€‚é…ç‰ˆ)</title>
    <style>
        :root { --primary: #1A73E8; --green: #34A853; --orange: #FBBC04; --red: #EA4335; --purple: #A142F4; --bg: #F8F9FA; --text: #202124; --border: #DADCE0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Google Sans', Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; /* V38: ç¦æ­¢é¡µé¢çº§æ»šåŠ¨ */ }
        
        /* å¯¼èˆªæ  */
        .navbar { background: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        .nav-title { font-weight: 500; font-size: 18px; color: var(--primary); }
        .mode-switch { background: #F1F3F4; padding: 4px; border-radius: 20px; }
        .mode-btn { border: none; background: none; padding: 6px 16px; font-weight: 600; border-radius: 18px; color: #5F6368; cursor: pointer; transition: 0.2s; }
        .mode-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .container { padding: 15px; max-width: 800px; margin: 0 auto; flex: 1; overflow-y: auto; width: 100%; } /* ç¼–è¾‘é¡µå…è®¸æ»šåŠ¨ */
        .card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(60,64,67,0.15); }
        .hidden { display: none !important; }

        /* Practice Mode Layout (V38 æ ¸å¿ƒå¸ƒå±€é‡æ„) */
        #practice-view { 
            display: flex; 
            flex-direction: column; 
            height: 100%; /* å æ»¡å‰©ä½™é«˜åº¦ */
            padding: 10px; 
            overflow: hidden; /* ç¦æ­¢å¤–å±‚æ»šåŠ¨ */
        }
        
        .practice-card { 
            background: #fff; 
            border-radius: 16px; 
            padding: 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            display: flex; 
            flex-direction: column; 
            height: 100%; /* å¡ç‰‡å æ»¡å®¹å™¨ */
            overflow: hidden; 
        }

        .practice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .menu-btn { font-size: 24px; cursor: pointer; padding: 0 10px; color: #333; }
        .jump-select { font-size: 16px; font-weight: 600; background: #F1F3F4; border: none; padding: 6px 20px; border-radius: 20px; outline: none; text-align: center; }
        
        .sub-switcher { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; flex-shrink: 0; }
        .sub-btn { font-size: 12px; padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border); background: #fff; cursor: pointer; color: #5F6368; }
        .sub-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* V38: å¼¹æ€§æ–‡å­—å®¹å™¨ */
        .practice-text-container { 
            flex: 1; /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            cursor: pointer; 
            margin: 10px 0; 
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
            background: #FAFAFA; /* æ·¡æ·¡çš„èƒŒæ™¯æç¤ºåŒºåŸŸ */
            border-radius: 12px;
            border: 1px dashed #eee;
        }
        
        .practice-text { 
            width: 100%;
            max-height: 100%;
            padding: 20px;
            font-size: 32px; /* é»˜è®¤å¤§å­—ä½“ */
            line-height: 1.4;
            font-weight: 500;
            color: var(--text);
            text-align: center;
            overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å†…éƒ¨æ»šåŠ¨ */
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .practice-text::-webkit-scrollbar { display: none; }

        .practice-text.blur { filter: blur(12px); opacity: 0.3; overflow: hidden; }
        
        .click-hint { 
            position: absolute; 
            bottom: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 12px; 
            color: #999; 
            opacity: 0.6; 
            pointer-events: none; 
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* åº•éƒ¨æ§åˆ¶åŒº (å›ºå®šé«˜åº¦) */
        .control-area { 
            flex-shrink: 0; /* ä¸å…è®¸è¢«å‹ç¼© */
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-top: auto; 
            padding-top: 10px;
            border-top: 1px solid #f5f5f5;
        }

        /* æŒ‰é’®æ ·å¼ç»´æŒä¸å˜ */
        .btn-full-play { width: 100%; background: var(--purple); color: white; border: none; padding: 12px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-full-play.active { background: #D93025; animation: pulse 2s infinite; }
        
        .range-panel { background: #F1F3F4; padding: 8px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }
        .range-select { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 4px; width: 50px; text-align: center; }
        .btn-range-play { background: var(--purple); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-range-play.active { background: #D93025; animation: pulse 2s infinite; }

        .top-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .small-btn { padding: 12px; border-radius: 12px; border: none; font-weight: 600; background: #E8F0FE; color: var(--primary); cursor: pointer; }
        .small-btn.active { background: var(--primary); color: white; }
        .small-btn.looping { background: #FEF7E0; color: #EA8600; border: 1px solid #F9AB00; }

        .btn-record { width: 100%; padding: 18px; border-radius: 16px; border: 2px solid #E8EAED; background: #fff; font-size: 18px; font-weight: 700; color: #3C4043; cursor: pointer; }
        .btn-record.recording { background: #FCE8E6; border-color: var(--red); color: var(--red); animation: pulse 1s infinite; }
        .btn-record.playing { background: #E6F4EA; border-color: var(--green); color: var(--green); }

        .nav-controls { display: flex; gap: 12px; }
        .nav-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: #F1F3F4; font-weight: 600; cursor: pointer; }

        /* ç¼–è¾‘é¡µæ ·å¼ (ä¿æŒåŸæ ·) */
        .input-tabs { display: flex; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 8px 12px; font-size: 14px; color: #5F6368; cursor: pointer; border-radius: 6px; font-weight: 500; }
        .tab-btn.active { background: #E8F0FE; color: var(--primary); }
        .input-group { display: none; }
        .input-group.active { display: block; }
        .url-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
        .btn-load-url { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
        .loading-spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite; display: none; }
        .file-box { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
        .btn-file { flex: 1; min-width: 100px; background: #F1F3F4; padding: 12px; border-radius: 8px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; position: relative; }
        .btn-file input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; }
        .btn-file.primary { background: #E8F0FE; color: var(--primary); }
        .btn-file.green { background: #E6F4EA; color: #137333; }
        .sub-item { background: #fff; padding: 16px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; }
        .sub-meta { display: flex; justify-content: space-between; font-size: 12px; color: #5F6368; margin-bottom: 8px; }
        .sub-line { padding: 8px; border: 1px solid #eee; border-radius: 4px; font-size: 15px; width: 100%; resize: vertical; margin-bottom: 5px; }
        .sub-actions { display: flex; gap: 8px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; }
        
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; display: none; }
        .drawer-overlay.open { display: block; }
        .drawer-content { width: 80%; max-width: 300px; height: 100%; background: #fff; padding: 20px; position: absolute; left: 0; top: 0; transform: translateX(-100%); transition: 0.3s; z-index: 501; display: flex; flex-direction: column; gap: 10px; }
        .drawer-overlay.open .drawer-content { transform: translateX(0); }

        .audio-status { font-size: 13px; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; }
        .audio-status.warn { background: #FCE8E6; color: #C5221F; }
        .audio-status.ok { background: #E6F4EA; color: #137333; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999; }
        .toast.show { opacity: 1; bottom: 100px; }
        .restore-bar { background: #FFF3E0; color: #E65100; padding: 12px; text-align: center; font-size: 14px; display: none; cursor: pointer; border-bottom: 1px solid #FEEFC3; font-weight: 500; }
    </style>
</head>
<body>

    <div id="restore-bar" class="restore-bar" onclick="app.restoreProgress()">
        ğŸ”„ å‘ç°ä¸Šæ¬¡è¿›åº¦ (ç¬¬<span id="restore-idx">1</span>å¥)ï¼Œç‚¹å‡»æ¢å¤
    </div>

    <div class="navbar">
        <div class="nav-title">ğŸ§ å½±å­è·Ÿè¯» V38</div>
        <div class="mode-switch">
            <button class="mode-btn active" onclick="app.switchView('editor')">ç¼–è¾‘</button>
            <button class="mode-btn" onclick="app.switchView('practice')">ç»ƒä¹ </button>
        </div>
    </div>

    <audio id="main-audio" crossorigin="anonymous"></audio>
    <audio id="record-audio"></audio>

    <div id="editor-view" class="container">
        <!-- ç¼–è¾‘é¡µå†…å®¹ä¿æŒä¸å˜ -->
        <div class="card">
            <div id="audio-status-msg" class="audio-status"></div>
            <div class="input-tabs">
                <div class="tab-btn active" onclick="ui.setTab('url')">ğŸŒ ç½‘ç»œé“¾æ¥</div>
                <div class="tab-btn" onclick="ui.setTab('local')">ğŸ“ æœ¬åœ°æ–‡ä»¶</div>
            </div>
            <div id="group-url" class="input-group active">
                <select id="history-select" class="history-select" style="width:100%;padding:10px;margin-bottom:10px;" onchange="app.fillHistory(this.value)"><option value="">â–¼ é€‰æ‹©å†å²è®°å½•...</option></select>
                <input type="text" class="url-input" id="url-audio" placeholder="ç²˜è´´ MP3 é“¾æ¥..." onchange="app.saveInput()">
                <input type="text" class="url-input" id="url-srt-1" placeholder="å­—å¹• 1 (ä¸»)" onchange="app.saveInput()">
                <input type="text" class="url-input" id="url-srt-2" placeholder="å­—å¹• 2" onchange="app.saveInput()">
                <input type="text" class="url-input" id="url-srt-3" placeholder="å­—å¹• 3" onchange="app.saveInput()">
                <button class="btn-load-url" id="btn-load-url" onclick="app.loadFromUrl()">
                    <span class="loading-spinner" id="url-spinner"></span> ğŸš€ æé€ŸåŠ è½½
                </button>
            </div>
            <div id="group-local" class="input-group">
                <div class="file-box">
                    <div class="btn-file primary">ğŸµ å¯¼å…¥ MP3 <input type="file" id="audio-file" accept="audio/*"></div>
                    <div class="btn-file sub-slot">ğŸ“„ å­—å¹• 1 <input type="file" onchange="app.importSub(this, 0)" accept=".srt,.txt"></div>
                    <div class="btn-file sub-slot">ğŸ“„ å­—å¹• 2 <input type="file" onchange="app.importSub(this, 1)" accept=".srt,.txt"></div>
                    <div class="btn-file sub-slot">ğŸ“„ å­—å¹• 3 <input type="file" onchange="app.importSub(this, 2)" accept=".srt,.txt"></div>
                </div>
            </div>
            <div class="file-box" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                <button class="btn-file" onclick="app.exportProject()">ğŸ’¾ ä¿å­˜å·¥ç¨‹</button>
                <div class="btn-file">ğŸ“‚ åŠ è½½å·¥ç¨‹ <input type="file" id="project-file" accept=".json" onclick="this.value=null"></div>
                <button class="btn-file green" onclick="app.exportSRT(1)">â¬‡ï¸ å¯¼å‡ºå­—1</button>
                <button class="btn-file green" onclick="app.exportSRT(2)">â¬‡ï¸ å¯¼å‡ºå­—2</button>
                <button class="btn-file green" onclick="app.exportSRT(3)">â¬‡ï¸ å¯¼å‡ºå­—3</button>
            </div>
            <div style="margin-top:15px; display:flex; gap:10px; align-items:center; background:#f9f9f9; padding:10px; border-radius:8px;">
                <span style="font-size:12px;">âœ‚ï¸ æ–­å¥çµæ•åº¦:</span>
                <input type="range" id="threshold-range" min="0.01" max="0.1" step="0.01" value="0.02" style="flex:1" oninput="ui.updateThresh(this.value)">
                <span id="threshold-val" style="font-family:monospace; font-size:12px;">0.02</span>
                <button class="btn-mini" style="padding:4px 8px; font-size:12px; background:var(--primary); color:#fff; border:none; border-radius:4px;" onclick="app.applyReAnalyze()">æ‰§è¡Œ</button>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:12px; color:#666">å…± <span id="row-count">0</span> å¥</div>
        </div>
        <div id="editor-list"></div>
        <div style="text-align:center; padding:20px;">
            <button class="btn-file" style="display:inline-flex; width:auto; border:1px dashed #ccc;" onclick="app.addNewRow()">+ æ·»åŠ ç©ºè¡Œ</button>
        </div>
    </div>

    <!-- ç»ƒä¹ æ¨¡å¼ (æ ¸å¿ƒä¿®å¤) -->
    <div id="practice-view" class="container hidden">
        <div class="practice-card">
            <div id="drawer-overlay" class="drawer-overlay" onclick="ui.toggleDrawer()">
                <div class="drawer-content" onclick="event.stopPropagation()">
                    <h3>âš™ï¸ èœå•</h3>
                    <button class="btn-file" onclick="app.exportProject()">ğŸ’¾ å¤‡ä»½å·¥ç¨‹</button>
                    <button class="btn-file" onclick="app.exportSRT(1)">â¬‡ï¸ å¯¼å‡ºå­—å¹•1</button>
                    <button class="btn-file" style="margin-top:10px" onclick="ui.toggleDrawer()">å…³é—­</button>
                </div>
            </div>

            <div class="practice-header">
                <div onclick="ui.toggleDrawer()" style="font-size:24px; cursor:pointer">â˜°</div>
                <select id="jump-select" class="jump-select" onchange="app.jumpTo(this.value)"><option>1</option></select>
                <div id="text-toggle-btn" style="color:var(--primary); font-weight:bold; cursor:pointer" onclick="ui.toggleTextBlur()">ğŸ‘ï¸ æ˜¾ç¤º</div>
            </div>

            <div class="sub-switcher">
                <button class="sub-btn active" onclick="ui.switchSubTab(0)">å­—å¹•1</button>
                <button class="sub-btn" onclick="ui.switchSubTab(1)">å­—å¹•2</button>
                <button class="sub-btn" onclick="ui.switchSubTab(2)">å­—å¹•3</button>
            </div>
            
            <!-- V38: å¼¹æ€§æ–‡å­—å®¹å™¨ -->
            <div class="practice-text-container" onclick="ui.toggleTextBlur()">
                <div id="practice-text-display" class="practice-text blur">(è¯·åŠ è½½å†…å®¹)</div>
                <div class="click-hint">ğŸ‘† ç‚¹å‡»åˆ‡æ¢æ˜¾éš</div>
            </div>

            <div class="control-area">
                <button class="btn-full-play" id="btn-full-play" onclick="engine.toggleFullPlay()">ğŸ§ å…¨æ–‡å¾ªç¯ (ç£¨è€³æœµ)</button>
                
                <div class="range-panel">
                    <span>ğŸ”„ èŒƒå›´:</span>
                    <input type="number" id="loop-start" class="range-select" value="1" min="1">
                    - <input type="number" id="loop-end" class="range-select" value="10" min="1">
                    <button class="btn-range-play" id="btn-range-play" onclick="engine.toggleRangeLoop()">â–¶ å¾ªç¯</button>
                </div>

                <div class="top-btns">
                    <button class="small-btn" id="btn-play-once" onclick="engine.playOnce()">â–¶ æ’­å•å¥</button>
                    <button class="small-btn" id="btn-loop" onclick="engine.toggleLoop()">ğŸ”„ å¾ªç¯å•å¥</button>
                </div>
                <button class="btn-record" id="btn-record" onclick="recorder.toggle()">ğŸ¤ æŒ‰ä¸‹å¼€å§‹å½•éŸ³</button>
                <div class="nav-controls">
                    <button class="nav-btn" onclick="app.prev()">â¬…ï¸ ä¸Šä¸€å¥</button>
                    <button class="nav-btn" onclick="app.next()">ä¸‹ä¸€å¥ â¡ï¸</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤º</div>

<script>
const CONST = { STORAGE: 'shadow_v38_data', INDEX: 'shadow_v38_idx', HIST: 'shadow_v38_hist', INPUTS: 'shadow_v38_inputs', PROXY: ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='] };
const state = { segments: [], currIndex: 0, activeSub: 0, audioBuffer: null, userBlurState: true };

const engine = {
    mode: 'IDLE', reqId: null, editorTimer: null, isWaiting: false,
    startTicker() { if(this.reqId) cancelAnimationFrame(this.reqId); this.tick(); },
    stopAll(releaseMic = false) {
        this.mode = 'IDLE'; this.isWaiting = false;
        const a = document.getElementById('main-audio'); const r = document.getElementById('record-audio');
        a.pause(); r.pause(); a.loop = false;
        if(this.reqId) cancelAnimationFrame(this.reqId); clearTimeout(this.editorTimer);
        recorder.stop(releaseMic); ui.resetButtons();
    },
    playSegment(i) {
        this.stopAll();
        const s = state.segments[i]; const a = document.getElementById('main-audio');
        if(!a.src) return ui.toast("éŸ³é¢‘æœªå°±ç»ª");
        a.currentTime = s.start; a.play();
        this.editorTimer = setTimeout(() => a.pause(), (s.end - s.start) * 1000);
    },
    tick() {
        this.reqId = requestAnimationFrame(() => this.tick());
        const a = document.getElementById('main-audio');
        if(a.paused) return;
        const ct = a.currentTime;

        if (this.mode === 'PLAY_ONCE') {
            const seg = state.segments[state.currIndex];
            if (seg && ct >= seg.end) { a.pause(); this.mode = 'IDLE'; ui.resetButtons(); }
        } else if (this.mode === 'LOOP_ONE') {
            if(this.isWaiting) return;
            const seg = state.segments[state.currIndex];
            if (seg && ct >= seg.end) {
                this.startWait(() => { a.currentTime = seg.start; a.play(); });
            }
        } else if (this.mode === 'LOOP_RANGE') {
            if(this.isWaiting) return;
            const seg = state.segments[state.currIndex];
            const endLimit = parseInt(document.getElementById('loop-end').value) - 1;
            const startLimit = parseInt(document.getElementById('loop-start').value) - 1;
            if (seg && ct >= seg.end) {
                let nextIdx = state.currIndex + 1;
                if (nextIdx > endLimit || nextIdx >= state.segments.length) nextIdx = Math.max(0, startLimit);
                this.startWait(() => {
                    state.currIndex = nextIdx;
                    a.currentTime = state.segments[nextIdx].start;
                    ui.updatePractice(nextIdx);
                    a.play();
                });
            }
        } else if (this.mode === 'FULL_PLAY') {
            const activeIdx = state.segments.findIndex(s => ct >= s.start && ct < s.end);
            if (activeIdx !== -1 && activeIdx !== state.currIndex) {
                state.currIndex = activeIdx; ui.updatePractice(activeIdx);
            }
            if (a.ended || (a.duration > 0 && ct >= a.duration - 0.2)) {
                a.currentTime = 0; a.play();
                state.currIndex = 0; ui.updatePractice(0);
            }
        }
    },
    startWait(cb) {
        this.isWaiting = true;
        const a = document.getElementById('main-audio');
        a.pause();
        setTimeout(() => {
            this.isWaiting = false;
            cb();
        }, 1500); 
    },
    playOnce() { this.stopAll(); if(!this.check()) return; this.mode = 'PLAY_ONCE'; document.getElementById('btn-play-once').classList.add('active'); this.startPlay(); },
    toggleLoop() { if(this.mode === 'LOOP_ONE') this.stopAll(); else { this.stopAll(); if(!this.check()) return; this.mode = 'LOOP_ONE'; document.getElementById('btn-loop').classList.add('active'); this.startPlay(); } },
    toggleRangeLoop() { if(this.mode === 'LOOP_RANGE') this.stopAll(); else { this.stopAll(); if(!state.segments.length) return ui.toast("æ— å†…å®¹"); const start = Math.max(0, parseInt(document.getElementById('loop-start').value)-1); state.currIndex = start; ui.updatePractice(start); this.mode = 'LOOP_RANGE'; document.getElementById('btn-range-play').classList.add('active'); document.getElementById('btn-range-play').innerText = "â¸ åœæ­¢"; this.startPlay(); } },
    toggleFullPlay() { if(this.mode === 'FULL_PLAY') this.stopAll(); else { this.stopAll(); if(!this.check()) return; const a = document.getElementById('main-audio'); a.currentTime = 0; state.currIndex = 0; ui.updatePractice(0); a.loop = true; a.play().then(()=>{ this.mode = 'FULL_PLAY'; document.getElementById('btn-full-play').classList.add('active'); document.getElementById('btn-full-play').innerText = "â¸ åœæ­¢ç£¨è€³æœµ"; this.startTicker(); }); } },
    startPlay() { const seg = state.segments[state.currIndex]; const a = document.getElementById('main-audio'); a.currentTime = seg.start; a.play().then(() => this.startTicker()).catch(e => { console.error(e); ui.toast("æ’­æ”¾å¤±è´¥"); }); },
    check() { if(!state.segments.length) { ui.toast("è¯·å…ˆåŠ è½½å†…å®¹"); return false; } if(!document.getElementById('main-audio').src) { ui.toast("éŸ³é¢‘æœªå°±ç»ª"); return false; } return true; }
};

const ui = {
    init() {
        const p = new URLSearchParams(location.search);
        if(p.get('mp3')) {
            document.getElementById('url-audio').value = p.get('mp3');
            if(p.get('srt')) document.getElementById('url-srt-1').value = p.get('srt');
            setTimeout(() => app.loadFromUrl(), 500);
        } else {
            const inputs = JSON.parse(localStorage.getItem(CONST.INPUTS) || '{}');
            if(inputs.mp3) document.getElementById('url-audio').value = inputs.mp3;
            if(inputs.s1) document.getElementById('url-srt-1').value = inputs.s1;
            if(inputs.s2) document.getElementById('url-srt-2').value = inputs.s2;
            if(inputs.s3) document.getElementById('url-srt-3').value = inputs.s3;
        }
        this.renderHistory();
        const d = localStorage.getItem(CONST.STORAGE);
        if(d && JSON.parse(d).length) {
            document.getElementById('restore-idx').innerText = parseInt(localStorage.getItem(CONST.INDEX)||0)+1;
            document.getElementById('restore-bar').style.display = 'block';
        }
        this.updateAudioStatus();
    },
    renderHistory() {
        const h = JSON.parse(localStorage.getItem(CONST.HIST)||'[]');
        const sel = document.getElementById('history-select');
        sel.innerHTML = '<option value="">â–¼ é€‰æ‹©æœ€è¿‘ä½¿ç”¨çš„è¯¾ç¨‹...</option>';
        h.forEach((item, i) => { const opt = document.createElement('option'); opt.value = i; opt.text = item.name; sel.appendChild(opt); });
    },
    setTab(t) {
        document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active', (t==='url' && i===0) || (t==='local' && i===1)));
        document.getElementById('group-url').style.display = t==='url' ? 'block' : 'none';
        document.getElementById('group-local').style.display = t==='local' ? 'block' : 'none';
    },
    updateThresh(v) { document.getElementById('threshold-val').innerText = v; },
    toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); },
    updateAudioStatus() {
        const m = document.getElementById('audio-status-msg'); const a = document.getElementById('main-audio');
        if(a.src && a.src!==location.href) { m.className='audio-status ok'; m.style.display='block'; m.innerText="âœ… éŸ³é¢‘å·²å°±ç»ª"; setTimeout(()=>m.style.display='none',3000); }
        else { m.className='audio-status warn'; m.style.display='block'; m.innerText="âš ï¸ éŸ³é¢‘æœªå°±ç»ª"; }
    },
    resetButtons() {
        document.getElementById('btn-play-once').classList.remove('active');
        document.getElementById('btn-loop').classList.remove('active');
        const rangeBtn = document.getElementById('btn-range-play'); rangeBtn.classList.remove('active'); rangeBtn.innerText = "â–¶ å¾ªç¯";
        const fullBtn = document.getElementById('btn-full-play'); fullBtn.classList.remove('active'); fullBtn.innerText = "ğŸ§ å…¨æ–‡å¾ªç¯ (ç£¨è€³æœµ)";
        const recBtn = document.getElementById('btn-record'); recBtn.classList.remove('recording', 'playing'); recBtn.innerText = "ğŸ¤ æŒ‰ä¸‹å¼€å§‹å½•éŸ³";
    },
    renderEditor() {
        const l = document.getElementById('editor-list'); l.innerHTML='';
        document.getElementById('row-count').innerText = state.segments.length;
        state.segments.forEach((s,i)=>{
            const d = document.createElement('div'); d.className='sub-item';
            d.innerHTML = `
                <div class="sub-meta">
                    <span class="idx-badge">#${i+1}</span>
                    <div class="time-edit-group">
                        <input type="number" class="time-input" value="${s.start.toFixed(2)}" step="0.1" onchange="app.updateSeg(${i},'start',this.value)"> - 
                        <input type="number" class="time-input" value="${s.end.toFixed(2)}" step="0.1" onchange="app.updateSeg(${i},'end',this.value)">
                    </div>
                </div>
                ${s.text!==undefined ? `<div class="sub-text-block"><span class="sub-label">SUB 1</span><textarea class="sub-line" onchange="app.updateSeg(${i},'text',this.value)">${s.text}</textarea></div>` : ''}
                ${s.text2!==undefined ? `<div class="sub-text-block"><span class="sub-label">SUB 2</span><textarea class="sub-line" onchange="app.updateSeg(${i},'text2',this.value)">${s.text2}</textarea></div>` : ''}
                ${s.text3!==undefined ? `<div class="sub-text-block"><span class="sub-label">SUB 3</span><textarea class="sub-line" onchange="app.updateSeg(${i},'text3',this.value)">${s.text3}</textarea></div>` : ''}
                <div class="sub-actions">
                    <button class="action-btn btn-play-sm" onclick="engine.playSegment(${i})">â–¶ è¯•å¬</button>
                    <button class="action-btn btn-split" onclick="app.splitSeg(${i})">âœ‚ï¸ æ‹†åˆ†</button>
                    <button class="action-btn btn-merge" onclick="app.mergeSeg(${i})">ğŸ”— åˆå¹¶</button>
                    <button class="action-btn btn-del" onclick="app.delSeg(${i})">âœ• åˆ é™¤</button>
                </div>`;
            l.appendChild(d);
        });
        document.getElementById('loop-start').max = state.segments.length;
        document.getElementById('loop-end').max = state.segments.length;
        document.getElementById('loop-end').value = state.segments.length;
        const sel = document.getElementById('jump-select'); sel.innerHTML='';
        state.segments.forEach((_,i)=>{ const o=document.createElement('option'); o.value=i; o.text=`ç¬¬ ${i+1} å¥`; sel.appendChild(o); });
        app.save();
    },
    updatePractice(idx) {
        if(!state.segments[idx]) return;
        const key = state.activeSub===1 ? 'text2' : (state.activeSub===2 ? 'text3' : 'text');
        const txt = document.getElementById('practice-text-display');
        const content = state.segments[idx][key] || "(æ— å†…å®¹)";
        txt.innerText = content;
        
        // V38: å­—ä½“è‡ªé€‚åº” (FitText)
        this.fitText(txt);
        
        if (state.userBlurState) {
            txt.classList.add("blur");
            document.getElementById('text-toggle-btn').innerText = "ğŸ‘ï¸ æ˜¾ç¤º";
        } else {
            txt.classList.remove("blur");
            document.getElementById('text-toggle-btn').innerText = "ğŸ™ˆ éšè—";
        }
        
        if (content === "(æ— å†…å®¹)") txt.className = "practice-text empty";
        document.getElementById('jump-select').value = idx;
    },
    fitText(el) {
        let size = 32; el.style.fontSize = size + 'px';
        while (el.scrollHeight > el.clientHeight && size > 14) {
            size--; el.style.fontSize = size + 'px';
        }
    },
    toggleTextBlur() { state.userBlurState = !state.userBlurState; ui.updatePractice(state.currIndex); },
    switchSubTab(i) { state.activeSub = i; document.querySelectorAll('.sub-btn').forEach((b,k)=>b.classList.toggle('active',k===i)); ui.updatePractice(state.currIndex); },
    toggleDrawer() { document.getElementById('drawer-overlay').classList.toggle('open'); }
};

const app = {
    saveInput() {
        const d = { mp3: document.getElementById('url-audio').value, s1: document.getElementById('url-srt-1').value, s2: document.getElementById('url-srt-2').value, s3: document.getElementById('url-srt-3').value };
        localStorage.setItem(CONST.INPUTS, JSON.stringify(d));
    },
    addHistory(mp3, name) {
        let h = JSON.parse(localStorage.getItem(CONST.HIST)||'[]');
        h = h.filter(i=>i.mp3!==mp3);
        const d = JSON.parse(localStorage.getItem(CONST.INPUTS));
        h.unshift({name: name||mp3.split('/').pop(), mp3, ...d});
        if(h.length>10) h.pop();
        localStorage.setItem(CONST.HIST, JSON.stringify(h));
        ui.renderHistory();
    },
    fillHistory(i) {
        if(i==="") return;
        const h = JSON.parse(localStorage.getItem(CONST.HIST)||'[]');
        const item = h[i];
        if(item) {
            document.getElementById('url-audio').value = item.mp3;
            document.getElementById('url-srt-1').value = item.s1||'';
            document.getElementById('url-srt-2').value = item.s2||'';
            document.getElementById('url-srt-3').value = item.s3||'';
            this.saveInput();
        }
    },
    async loadFromUrl() {
        this.saveInput();
        const mp3 = this.fixUrl(document.getElementById('url-audio').value.trim());
        const s1 = this.fixUrl(document.getElementById('url-srt-1').value.trim());
        const s2 = this.fixUrl(document.getElementById('url-srt-2').value.trim());
        const s3 = this.fixUrl(document.getElementById('url-srt-3').value.trim());
        if(!mp3) return ui.toast("è¯·è¾“å…¥MP3é“¾æ¥");
        
        const btn = document.getElementById('btn-load-url'); const spin = document.getElementById('url-spinner');
        btn.disabled=true; spin.style.display='inline-block';
        
        try {
            ui.toast("ä¸‹è½½éŸ³é¢‘ä¸­...");
            let audioBlob = null;
            if (mp3.includes('aliyuncs.com')) { try { const r = await fetch(mp3); if (r.ok) audioBlob = await r.blob(); } catch(e) {} }
            if (!audioBlob) { for(const p of CONST.PROXY) { try { const r=await fetch(p+encodeURIComponent(mp3)); if(r.ok){ audioBlob=await r.blob(); break; } } catch(e){} } }
            if(!audioBlob) { try { const r=await fetch(mp3); if(r.ok) audioBlob=await r.blob(); } catch(e){} }
            if(!audioBlob) throw new Error("éŸ³é¢‘ä¸‹è½½å¤±è´¥");
            document.getElementById('main-audio').src = URL.createObjectURL(audioBlob);

            const loadTxt = async (u) => {
                if(!u) return null;
                for(const p of CONST.PROXY) { try { const r=await fetch(p+encodeURIComponent(u)); if(r.ok) return await r.text(); } catch(e){} }
                try { const r=await fetch(u); if(r.ok) return await r.text(); } catch(e){}
                return null;
            };

            const [t1, t2, t3] = await Promise.all([loadTxt(s1), loadTxt(s2), loadTxt(s3)]);
            if(t1) {
                state.segments = parseSRT(t1);
                if(t2) this.mergeSub(parseSRT(t2), 'text2');
                if(t3) this.mergeSub(parseSRT(t3), 'text3');
                ui.toast("å­—å¹•åŠ è½½æˆåŠŸ");
            } else {
                ui.toast("åˆ†ææ³¢å½¢ä¸­...");
                const ab = await audioBlob.arrayBuffer();
                const ctx = new (window.AudioContext||window.webkitAudioContext)();
                const decoded = await ctx.decodeAudioData(ab);
                state.audioBuffer = decoded;
                state.segments = detectSilence(decoded, 0.02);
                if(!state.segments.length) state.segments=[{start:0,end:decoded.duration,text:"(è‡ªåŠ¨æ–­å¥å¤±è´¥)"}];
                ui.toast(`è‡ªåŠ¨ç”Ÿæˆ ${state.segments.length} å¥`);
            }
            this.addHistory(mp3);
            ui.renderEditor(); ui.updateAudioStatus(); this.switchView('practice');
        } catch(e) { console.error(e); ui.toast("åŠ è½½å¤±è´¥: "+e.message); }
        finally { btn.disabled=false; spin.style.display='none'; }
    },
    fixUrl(u) {
        if(!u) return '';
        if(u.includes('gitee.com') && (u.includes('/edit/') || u.includes('/blob/'))) return u.replace(/\/edit\/|\/blob\//, '/raw/');
        if(u.includes('github.com') && u.includes('/blob/')) return u.replace('/blob/', '/raw/').replace('github.com', 'raw.githubusercontent.com');
        return u;
    },
    mergeSub(newS, k) { state.segments.forEach(b => { const m = newS.find(n => (n.start>=b.start && n.start<b.end)); if(m) b[k]=m.text; }); },
    switchView(v) {
        engine.stopAll();
        if(v==='practice' && !state.segments.length) return ui.toast("è¯·å…ˆåŠ è½½å†…å®¹");
        document.getElementById('editor-view').className = v==='editor'?'container':'container hidden';
        document.getElementById('practice-view').className = v==='practice'?'container hidden';
        if(v==='practice') document.getElementById('practice-view').className = 'container practice-view-container'; 
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(v)));
        if(v==='practice') this.loadItem(state.currIndex, false);
    },
    loadItem(i, play) {
        if(i<0 || i>=state.segments.length) return;
        state.currIndex = i; engine.stopAll();
        ui.updatePractice(i); this.save();
        if(play) engine.playOnce();
    },
    next() { 
        if(state.currIndex < state.segments.length-1) {
            state.userBlurState = true; 
            this.loadItem(state.currIndex+1, true); 
        }
    },
    prev() { 
        if(state.currIndex > 0) {
            state.userBlurState = true; 
            this.loadItem(state.currIndex-1, true); 
        }
    },
    jumpTo(v) { this.loadItem(parseInt(v), true); },
    updateSeg(i,k,v) { if(k.startsWith('text')) state.segments[i][k]=v; else state.segments[i][k]=parseFloat(v); this.save(); },
    delSegment(i) { state.segments.splice(i,1); ui.renderEditor(); },
    splitSeg(i) {
        const t = document.getElementById('main-audio').currentTime;
        if(t > state.segments[i].start && t < state.segments[i].end) {
            const old = state.segments[i];
            const newSeg = { start:t, end:old.end, text:"" };
            if(old.text2!==undefined) newSeg.text2="";
            if(old.text3!==undefined) newSeg.text3="";
            state.segments.splice(i+1, 0, newSeg);
            state.segments[i].end = t;
            ui.renderEditor();
        } else ui.toast("è¯·åœ¨è¯•å¬æ—¶æš‚åœäºæ‹†åˆ†ç‚¹");
    },
    mergeSeg(i) {
        if(i < state.segments.length-1) {
            state.segments[i].end = state.segments[i+1].end;
            state.segments[i].text = (state.segments[i].text + " " + (state.segments[i+1].text||"")).trim();
            if(state.segments[i].text2) state.segments[i].text2 += " " + (state.segments[i+1].text2||"");
            if(state.segments[i].text3) state.segments[i].text3 += " " + (state.segments[i+1].text3||"");
            state.segments.splice(i+1, 1);
            ui.renderEditor();
        }
    },
    addNewRow() { 
        const last=state.segments[state.segments.length-1]||{end:0}; 
        const newObj = {start:last.end,end:last.end+2,text:""};
        if(last.text2 !== undefined) newObj.text2 = "";
        if(last.text3 !== undefined) newObj.text3 = "";
        state.segments.push(newObj); 
        ui.renderEditor(); 
    },
    applyReAnalyze() {
        if(!state.audioBuffer) return ui.toast("éœ€å…ˆæˆåŠŸåŠ è½½éŸ³é¢‘æ•°æ®");
        const val = parseFloat(document.getElementById('threshold-range').value);
        state.segments = detectSilence(state.audioBuffer, val);
        ui.renderEditor(); ui.toast("é‡æ–°åˆ†æå®Œæˆ");
    },
    save() { localStorage.setItem(CONST.STORAGE, JSON.stringify(state.segments)); localStorage.setItem(CONST.INDEX, state.currIndex); },
    restoreProgress() {
        const d = localStorage.getItem(CONST.STORAGE); const i = localStorage.getItem(CONST.INDEX);
        if(d) { state.segments=JSON.parse(d); state.currIndex=parseInt(i)||0; ui.renderEditor(); document.getElementById('restore-bar').style.display='none'; ui.updateAudioStatus(); ui.toast("è¿›åº¦å·²æ¢å¤"); }
    },
    exportProject() { const b=new Blob([JSON.stringify({segments:state.segments, idx:state.currIndex})]); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='shadow.json'; a.click(); },
    exportSRT(slot) {
        if(!state.segments.length) return ui.toast("æ— æ•°æ®");
        let key = 'text'; if(slot===2) key='text2'; if(slot===3) key='text3';
        if(!state.segments.some(s=>s[key])) return ui.toast(`å­—å¹•${slot}æ— å†…å®¹`);
        let c=""; state.segments.forEach((s,i)=>{ c+=`${i+1}\n${fmtTime(s.start,1)} --> ${fmtTime(s.end,1)}\n${s[key]||''}\n\n`; }); 
        const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c],{type:'text/plain'})); a.download=`sub_${slot}.srt`; a.click(); 
    },
    loadProject(el) { const f=el.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const d=JSON.parse(e.target.result); state.segments=d.segments||d; state.currIndex=d.idx||0; ui.renderEditor(); ui.updateAudioStatus(); ui.toast("å·¥ç¨‹åŠ è½½æˆåŠŸ"); }; r.readAsText(f); },
    importSub(el, k) { const f=el.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const n=parseSRT(e.target.result); if(k===0) state.segments=n; else app.mergeSub(n, k===1?'text2':'text3'); ui.renderEditor(); }; r.readAsText(f); }
};

const recorder = {
    rec: null, chunks: [], stream: null, isRec: false,
    async toggle() {
        const btn = document.getElementById('btn-record');
        if(!this.isRec) {
            engine.stopAll();
            try {
                this.stream = await navigator.mediaDevices.getUserMedia({audio:true});
                this.rec = new MediaRecorder(this.stream);
                this.chunks = [];
                this.rec.ondataavailable = e => this.chunks.push(e.data);
                this.rec.onstop = () => { if(this.stream) this.stream.getTracks().forEach(t=>t.stop()); if(!this.forceStop) this.playCmp(); };
                this.rec.start(); this.isRec = true; btn.classList.add('recording'); btn.innerText="â¹ åœæ­¢å½•éŸ³";
            } catch(e) { alert("æ— éº¦å…‹é£æƒé™"); }
        } else { this.stop(false); }
    },
    stop(force) {
        if(this.isRec) { this.forceStop = force; this.rec.stop(); this.isRec = false; }
        document.getElementById('btn-record').classList.remove('recording');
        document.getElementById('btn-record').innerText="ğŸ¤ æŒ‰ä¸‹å¼€å§‹å½•éŸ³";
    },
    playCmp() {
        const s = state.segments[state.currIndex];
        const a = document.getElementById('main-audio'); const r = document.getElementById('record-audio');
        const b = new Blob(this.chunks, {type:'audio/mp3'}); r.src = URL.createObjectURL(b);
        ui.toast("ğŸ‘‚ åŸéŸ³"); a.currentTime = s.start; a.play();
        const timer = setInterval(() => {
            if(a.currentTime >= s.end) {
                a.pause(); clearInterval(timer);
                setTimeout(() => {
                    ui.toast("ğŸ—£ å½•éŸ³"); r.currentTime = 0; r.play();
                    r.onended = () => document.getElementById('btn-record').classList.remove('playing');
                    document.getElementById('btn-record').classList.add('playing');
                }, 500);
            }
        }, 30);
    }
};

document.getElementById('audio-file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) document.getElementById('main-audio').src=URL.createObjectURL(f); ui.updateAudioStatus(); });

function fmtTime(s, srt=false) { const d=new Date(0); d.setMilliseconds(s*1000); const str=d.toISOString().substr(11, 12); return srt ? str.replace('.', ',') : str.substr(3, 8); }
function parseSRT(t) { const r=[]; const e=/(\d+)?\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})\s-->\s(\d{2}:\d{2}:\d{2}[,.]\d{3})\s+([\s\S]*?)(?=\n\d+\s+\d{2}:\d{2}|$)/g; let m; while(m=e.exec(t)) r.push({start:pt(m[2]), end:pt(m[3]), text:m[4].trim()}); return r; }
function pt(s){ s=s.replace(',','.'); const p=s.split(':'); return parseInt(p[0])*3600 + parseInt(p[1])*60 + parseFloat(p[2]); }
function detectSilence(b,th){const d=b.getChannelData(0),sr=b.sampleRate,min=0.4*sr;let res=[],sp=false,st=0,sil=0;for(let i=0;i<d.length;i+=200){if(Math.abs(d[i])>th){if(!sp){sp=true;st=i;}sil=0;}else if(sp){if(!sil)sil=i;if(i-sil>min){const s=st/sr,e=sil/sr;if(e-s>0.3)res.push({start:s,end:e,text:""});sp=false;sil=0;}}}if(sp)res.push({start:st/sr,end:d.length/sr,text:""});return res;}

ui.init();
</script>
</body>
</html>